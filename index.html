<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>DA42NG Weight & Balance Calculator (Pixel Perfect Replica)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
  :root {
    --primary-color: #0078D4;
    --bg-color: #f4f7f9;
    --card-bg: #ffffff;
    --text-main: #1a1a1a;
    --text-sub: #666666;
    --input-bg: #fff9c4;
    --calc-bg: #ffffff;
    --border-color: #ddd;
    --alert-color: #d32f2f;
    --safe-color: #388e3c;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: var(--bg-color);
    margin: 0;
    padding: 20px;
    color: var(--text-main);
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--card-bg);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  header {
    margin-bottom: 25px;
    border-bottom: 3px solid var(--primary-color);
    padding-bottom: 10px;
  }

  header h1 { margin: 0; color: var(--primary-color); font-size: 22px; }

  .wb-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    font-size: 14px;
  }

  .wb-table th, .wb-table td {
    border: 1px solid var(--border-color);
    padding: 10px 12px;
    text-align: right;
  }

  .wb-table th { background: #f0f0f0; font-weight: bold; text-align: center; }
  .wb-table th.left-align { text-align: left; }

  .input-cell { background-color: var(--input-bg); width: 100px; padding: 0; }
  .input-cell input {
    width: 100%; height: 100%; border: none; background: transparent;
    text-align: right; font-size: 15px; font-weight: bold; padding: 10px 12px;
    box-sizing: border-box; outline: none;
  }

  .calc-cell { background-color: var(--calc-bg); font-weight: bold; }
  .fixed-cell { background-color: #fafafa; color: #666; }
  .section-row td { background-color: #f5f5f5; font-weight: bold; border-top: 2px solid #aaa; }
  .left-text { text-align: left !important; }

  .result-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 30px;
  }

  .result-card {
    background: #fff; border: 1px solid #ddd; padding: 20px;
    border-radius: 8px; text-align: center;
  }

  .result-card .value { font-size: 28px; font-weight: bold; display: block; }
  .status-ok { color: var(--safe-color); font-weight: bold; }
  .status-alert { color: var(--alert-color); font-weight: bold; }

  /* エンベロープのアスペクト比を図面と同期 */
  .chart-wrapper {
    width: 100%;
    max-width: 680px;
    margin: 40px auto 0;
    position: relative;
    border: 1px solid #ccc;
    background: white;
  }
  
  .chart-container {
    position: relative;
    width: 100%;
    padding-bottom: 75%; /* 図面のプロットエリアの横長比率を再現 */
    height: 0;
  }

  #wbChart {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>DA42NG Weight & Balance Calculator</h1>
    <p>JA224T Configuration (Precision Envelope Replica)</p>
  </header>

  <form id="wbForm">
    <table class="wb-table">
      <thead>
        <tr>
          <th class="left-align">Position</th>
          <th style="width: 60px;">Qty</th>
          <th style="width: 90px;">Weight (lbs)</th>
          <th style="width: 70px;">Arm (in)</th>
          <th>Moment (in-lbs)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="left-text">Basic Empty Weight</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="bew_weight" value="3150.4" step="0.1"></td>
          <td class="input-cell"><input type="number" id="bew_arm" value="94.7" step="0.1"></td>
          <td class="calc-cell" id="bew_mom">0</td>
        </tr>
        <tr>
          <td class="left-text">Pilot</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="p_w" value=""></td>
          <td class="fixed-cell">90.6</td>
          <td class="calc-cell" id="p_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Front Passenger</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="fp_w" value=""></td>
          <td class="fixed-cell">90.6</td>
          <td class="calc-cell" id="fp_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Rear Passenger 1</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="r1_w" value=""></td>
          <td class="fixed-cell">128.0</td>
          <td class="calc-cell" id="r1_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Rear Passenger 2</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="r2_w" value=""></td>
          <td class="fixed-cell">128.0</td>
          <td class="calc-cell" id="r2_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Nose (Max 66)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="cn_w" value="5"></td>
          <td class="fixed-cell">23.6</td>
          <td class="calc-cell" id="cn_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Cabin (Max 100)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="cc_w" value="20"></td>
          <td class="fixed-cell">153.1</td>
          <td class="calc-cell" id="cc_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Extend (Max 40)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="ce_w" value="2"></td>
          <td class="fixed-cell">178.7</td>
          <td class="calc-cell" id="ce_m">0</td>
        </tr>
        <tr>
          <td class="left-text">De-ice Fluid (9.2 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="di_g" value=""></td>
          <td class="calc-cell" id="di_w">0</td>
          <td class="fixed-cell">39.4</td>
          <td class="calc-cell" id="di_m">0</td>
        </tr>

        <tr class="section-row">
          <td colspan="2" class="left-text">Zero Fuel Condition (Max 3900)</td>
          <td class="calc-cell" id="zfw_w">0</td>
          <td class="calc-cell" id="zfw_cg">0</td>
          <td class="calc-cell" id="zfw_m">0</td>
        </tr>

        <tr>
          <td class="left-text">Main Fuel Load (7.01 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="mf_g" value=""></td>
          <td class="calc-cell" id="mf_w">0</td>
          <td class="fixed-cell">103.5</td>
          <td class="calc-cell" id="mf_m">0</td>
        </tr>
        <tr>
          <td class="left-text">AUX Fuel Load (7.01 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="af_g" value="0"></td>
          <td class="calc-cell" id="af_w">0</td>
          <td class="fixed-cell">126.0</td>
          <td class="calc-cell" id="af_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Runup/Taxi Burn off</td>
          <td class="fixed-cell">-1.0</td>
          <td class="fixed-cell">-7.01</td>
          <td class="fixed-cell">103.5</td>
          <td class="fixed-cell">-726</td>
        </tr>

        <tr class="section-row">
          <td colspan="2" class="left-text">Takeoff Condition (Max 4189)</td>
          <td class="calc-cell" id="tow_w">0</td>
          <td class="calc-cell" id="tow_cg">0</td>
          <td class="calc-cell" id="tow_m">0</td>
        </tr>

        <tr>
          <td class="left-text">Main Fuel for Flight</td>
          <td class="input-cell"><input type="number" id="mff_g" value=""></td>
          <td class="calc-cell" id="mff_w">0</td>
          <td class="fixed-cell">103.5</td>
          <td class="calc-cell" id="mff_m">0</td>
        </tr>
        <tr>
          <td class="left-text">AUX Fuel for Flight</td>
          <td class="input-cell"><input type="number" id="aff_g" value="0"></td>
          <td class="calc-cell" id="aff_w">0</td>
          <td class="fixed-cell">104.5</td>
          <td class="calc-cell" id="aff_m">0</td>
        </tr>

        <tr class="section-row">
          <td colspan="2" class="left-text">Landing Condition (Max 3979)</td>
          <td class="calc-cell" id="lw_w">0</td>
          <td class="calc-cell" id="lw_cg">0</td>
          <td class="calc-cell" id="lw_m">0</td>
        </tr>
      </tbody>
    </table>
  </form>

  <div class="result-summary">
    <div class="result-card">
      <h3>Takeoff Weight</h3>
      <span class="value" id="res_tow">0 lbs</span>
      <span id="res_tow_status" class="status-ok">Within Limits</span>
    </div>
    <div class="result-card">
      <h3>Landing Weight</h3>
      <span class="value" id="res_lw">0 lbs</span>
      <span id="res_lw_status" class="status-ok">Within Limits</span>
    </div>
    <div class="result-card">
      <h3>Takeoff C.G.</h3>
      <span class="value" id="res_cg">0 in</span>
    </div>
  </div>

  <div class="chart-wrapper">
    <div class="chart-container">
      <canvas id="wbChart"></canvas>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('wbChart').getContext('2d');
  
  // PDF図面とAFMデータに基づき、左縦線の長さと左斜線の開始位置を完全修正
  const envelopeData = [
    {x: 92.52, y: 3197},  // 左下端
    {x: 92.52, y: 3252},  // 左側垂直線 (3252 lbs / 1475 kg までの極短区間)
    {x: 94.61, y: 4189},  // 左斜線（前方限界）の終点
    {x: 97.64, y: 4189},  // 上辺（最大離陸重量）
    {x: 97.64, y: 3748},  // 右側垂直線（1700 kg までの垂直区間）
    {x: 96.46, y: 3197},  // 右下端
    {x: 92.52, y: 3197}   // 閉じる
  ];

  const chart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Envelope',
          data: envelopeData,
          showLine: true, borderColor: '#000', borderWidth: 2, pointRadius: 0, fill: false, tension: 0, z: 5
        },
        {
          label: 'Max Zero Fuel',
          data: [{x: 92, y: 3900}, {x: 98, y: 3900}],
          showLine: true, borderColor: 'red', borderDash: [5, 3], borderWidth: 1, pointRadius: 0
        },
        {
          label: 'MAX Landing Weight',
          data: [{x: 92, y: 3979}, {x: 98, y: 3979}],
          showLine: true, borderColor: 'green', borderDash: [2, 2], borderWidth: 1, pointRadius: 0
        },
        {
          label: 'Flight States',
          data: [], backgroundColor: 'blue', pointRadius: 6, pointHoverRadius: 8, z: 10
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { 
          min: 92.0, max: 98.0, 
          grid: { color: '#e0e0e0', lineWidth: 1, drawBorder: true },
          ticks: {
            stepSize: 0.5,
            callback: function(value) {
                // PDFの通り 92, 94, 96, 98 のみラベル表示
                return [92, 94, 96, 98].includes(value) ? value : '';
            },
            font: { size: 12, weight: 'bold' }
          },
          title: { display: true, text: 'C.G. Inches Aft of Datum', font: { size: 13, weight: 'bold' } } 
        },
        y: { 
          min: 3100, max: 4200, 
          grid: { color: '#e0e0e0', lineWidth: 1, drawBorder: true },
          ticks: {
            stepSize: 100,
            callback: function(value) {
                // PDFの通り 3100, 3300... と200刻みでラベル表示
                return [3100, 3300, 3500, 3700, 3900, 4100].includes(value) ? value : '';
            },
            font: { size: 12, weight: 'bold' }
          },
          title: { display: true, text: 'Weight (lbs)', font: { size: 13, weight: 'bold' } } 
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (context) => context.raw.label + ": (" + context.raw.x.toFixed(2) + ", " + context.raw.y.toFixed(0) + ")"
          }
        }
      }
    }
  });

  // 計算ロジック（変更なし）
  function getV(id) { return parseFloat(document.getElementById(id).value) || 0; }
  function setT(id, val, dec = 0) { 
    const el = document.getElementById(id);
    if(el) el.innerText = val.toLocaleString(undefined, {minimumFractionDigits: dec, maximumFractionDigits: dec});
  }

  function calculate() {
    const bw = getV('bew_weight'), ba = getV('bew_arm'), bm = bw * ba;
    setT('bew_mom', bm, 0);

    const items = [
      {w: getV('p_w'), a: 90.6, id: 'p_m'},
      {w: getV('fp_w'), a: 90.6, id: 'fp_m'},
      {w: getV('r1_w'), a: 128.0, id: 'r1_m'},
      {w: getV('r2_w'), a: 128.0, id: 'r2_m'},
      {w: getV('cn_w'), a: 23.6, id: 'cn_m'},
      {w: getV('cc_w'), a: 153.1, id: 'cc_m'},
      {w: getV('ce_w'), a: 178.7, id: 'ce_m'}
    ];
    let pW = 0, pM = 0;
    items.forEach(i => {
      const m = i.w * i.a; setT(i.id, m, 0); pW += i.w; pM += m;
    });

    const diW = getV('di_g') * 9.2, diM = diW * 39.4;
    setT('di_w', diW, 1); setT('di_m', diM, 0);

    const zfwW = bw + pW + diW, zfwM = bm + pM + diM;
    const zfwCG = zfwW > 0 ? zfwM / zfwW : 0;
    setT('zfw_w', zfwW, 1); setT('zfw_m', zfwM, 0); setT('zfw_cg', zfwCG, 2);

    const mfW = getV('mf_g') * 7.01, mfM = mfW * 103.5;
    setT('mf_w', mfW, 1); setT('mf_m', mfM, 0);
    const afW = getV('af_g') * 7.01, afM = afW * 126.0;
    setT('af_w', afW, 1); setT('af_m', afM, 0);

    const towW = zfwW + mfW + afW - 7.01, towM = zfwM + mfM + afM - 726;
    const towCG = towW > 0 ? towM / towW : 0;
    setT('tow_w', towW, 1); setT('tow_m', towM, 0); setT('tow_cg', towCG, 2);

    const mffW = getV('mff_g') * 7.01, mffM = mffW * 103.5;
    setT('mff_w', -mffW, 1); setT('mff_m', -mffM, 0);
    const affW = getV('aff_g') * 7.01, affM = affW * 104.5;
    setT('aff_w', -affW, 1); setT('aff_m', -affM, 0);

    const lwW = towW - mffW - affW, lwM = towM - mffM - affM;
    const lwCG = lwW > 0 ? lwM / lwW : 0;
    setT('lw_w', lwW, 1); setT('lw_m', lwM, 0); setT('lw_cg', lwCG, 2);

    document.getElementById('res_tow').innerText = towW.toFixed(1) + " lbs";
    document.getElementById('res_lw').innerText = lwW.toFixed(1) + " lbs";
    document.getElementById('res_cg').innerText = towCG.toFixed(2) + " in";

    const ts = document.getElementById('res_tow_status');
    ts.innerText = towW > 4189 ? "OVERWEIGHT!" : "Within Limits";
    ts.className = towW > 4189 ? "status-alert" : "status-ok";

    const ls = document.getElementById('res_lw_status');
    ls.innerText = lwW > 3979 ? "OVERWEIGHT!" : "Within Limits";
    ls.className = lwW > 3979 ? "status-alert" : "status-ok";

    chart.data.datasets[3].data = [
      {x: zfwCG, y: zfwW, label: 'ZFW'},
      {x: towCG, y: towW, label: 'TOW'},
      {x: lwCG, y: lwW, label: 'LDG'}
    ];
    chart.update();
  }

  document.querySelectorAll('input').forEach(i => i.addEventListener('input', calculate));
  calculate();
});
</script>

</body>
</html>
