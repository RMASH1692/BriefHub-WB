<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>DA42NG Weight & Balance Calculator (Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
  :root {
    --primary-color: #0078D4;
    --bg-color: #f4f7f9;
    --card-bg: #ffffff;
    --text-main: #1a1a1a;
    --input-bg: #fff9c4;
    --border-color: #ddd;
    --alert-color: #d32f2f;
    --safe-color: #388e3c;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: var(--bg-color);
    margin: 0;
    padding: 20px;
    color: var(--text-main);
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--card-bg);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  header {
    margin-bottom: 25px;
    border-bottom: 3px solid var(--primary-color);
    padding-bottom: 10px;
  }

  header h1 { margin: 0; color: var(--primary-color); font-size: 22px; }

  .wb-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    font-size: 14px;
  }

  .wb-table th, .wb-table td {
    border: 1px solid var(--border-color);
    padding: 10px 12px;
    text-align: right;
  }

  .wb-table th { background: #f0f0f0; font-weight: bold; text-align: center; }
  .wb-table th.left-align { text-align: left; }

  .input-cell { background-color: var(--input-bg); width: 100px; padding: 0; }
  
  /* 数値入力のスピンボタン（矢印）を消すCSS */
  .input-cell input::-webkit-outer-spin-button,
  .input-cell input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  .input-cell input[type=number] {
    -moz-appearance: textfield; /* Firefox用 */
    width: 100%; height: 100%; border: none; background: transparent;
    text-align: right; font-size: 15px; font-weight: bold; padding: 10px 12px;
    box-sizing: border-box; outline: none;
  }

  .calc-cell { background-color: #ffffff; font-weight: bold; }
  .fixed-cell { background-color: #fafafa; color: #666; }
  .section-row td { background-color: #f5f5f5; font-weight: bold; border-top: 2px solid #aaa; }
  .left-text { text-align: left !important; }

  .result-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 30px;
  }

  .result-card {
    background: #fff; border: 1px solid #ddd; padding: 20px;
    border-radius: 8px; text-align: center;
  }

  .result-card .value { font-size: 28px; font-weight: bold; display: block; }
  .status-ok { color: var(--safe-color); font-weight: bold; }
  .status-alert { color: var(--alert-color); font-weight: bold; }

  .chart-wrapper {
    width: 100%;
    margin: 40px 0 0;
    position: relative;
    border: 1px solid #ccc;
    background: white;
  }
   
  .chart-container {
    position: relative;
    width: 100%;
    padding-bottom: 65%;
    height: 0;
  }

  #wbChart {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  h2.chart-title {
    font-size: 18px;
    text-align: center;
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>DA42NG Weight & Balance Calculator</h1>
    <p>JA224T Configuration</p>
  </header>

  <form id="wbForm">
    <table class="wb-table">
      <thead>
        <tr>
          <th class="left-align">Position</th>
          <th style="width: 60px;">Qty</th>
          <th style="width: 90px;">Weight (lbs)</th>
          <th style="width: 70px;">Arm (in)</th>
          <th>Moment (in-lbs)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="left-text">Basic Empty Weight</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="bew_weight" value="3150.4" step="0.1"></td>
          <td class="input-cell"><input type="number" id="bew_arm" value="94.7" step="0.1"></td>
          <td class="calc-cell" id="bew_mom">0</td>
        </tr>
        <tr>
          <td class="left-text">Pilot</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="p_w" placeholder="0"></td>
          <td class="fixed-cell">90.6</td>
          <td class="calc-cell" id="p_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Front Passenger</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="fp_w" placeholder="0"></td>
          <td class="fixed-cell">90.6</td>
          <td class="calc-cell" id="fp_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Rear Passenger 1</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="r1_w" placeholder="0"></td>
          <td class="fixed-cell">128.0</td>
          <td class="calc-cell" id="r1_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Rear Passenger 2</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="r2_w" placeholder="0"></td>
          <td class="fixed-cell">128.0</td>
          <td class="calc-cell" id="r2_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Nose (Max 66)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="cn_w" placeholder="0"></td>
          <td class="fixed-cell">23.6</td>
          <td class="calc-cell" id="cn_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Cabin (Max 100)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="cc_w" placeholder="0"></td>
          <td class="fixed-cell">153.1</td>
          <td class="calc-cell" id="cc_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Extend (Max 40)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="ce_w" placeholder="0"></td>
          <td class="fixed-cell">178.7</td>
          <td class="calc-cell" id="ce_m">0</td>
        </tr>
        <tr>
          <td class="left-text">De-ice Fluid (9.2 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="di_g" placeholder="0"></td>
          <td class="calc-cell" id="di_w">0</td>
          <td class="fixed-cell">39.4</td>
          <td class="calc-cell" id="di_m">0</td>
        </tr>

        <tr class="section-row">
          <td colspan="2" class="left-text">Zero Fuel Condition (Max 3900)</td>
          <td class="calc-cell" id="zfw_w">0</td>
          <td class="calc-cell" id="zfw_cg">0</td>
          <td class="calc-cell" id="zfw_m">0</td>
        </tr>

        <tr>
          <td class="left-text">Main Fuel Load (7.01 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="mf_g" placeholder="0"></td>
          <td class="calc-cell" id="mf_w">0</td>
          <td class="fixed-cell">103.5</td>
          <td class="calc-cell" id="mf_m">0</td>
        </tr>
        <tr>
          <td class="left-text">AUX Fuel Load (7.01 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="af_g" placeholder="0"></td>
          <td class="calc-cell" id="af_w">0</td>
          <td class="fixed-cell">126.0</td>
          <td class="calc-cell" id="af_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Runup/Taxi Burn off</td>
          <td class="fixed-cell">-1.0</td>
          <td class="fixed-cell">-7.01</td>
          <td class="fixed-cell">103.5</td>
          <td class="fixed-cell">-726</td>
        </tr>

        <tr class="section-row">
          <td colspan="2" class="left-text">Takeoff Condition (Max 4189)</td>
          <td class="calc-cell" id="tow_w">0</td>
          <td class="calc-cell" id="tow_cg">0</td>
          <td class="calc-cell" id="tow_m">0</td>
        </tr>

        <tr>
          <td class="left-text">Main Fuel for Flight</td>
          <td class="input-cell"><input type="number" id="mff_g" placeholder="0"></td>
          <td class="calc-cell" id="mff_w">0</td>
          <td class="fixed-cell">103.5</td>
          <td class="calc-cell" id="mff_m">0</td>
        </tr>
        <tr>
          <td class="left-text">AUX Fuel for Flight</td>
          <td class="input-cell"><input type="number" id="aff_g" placeholder="0"></td>
          <td class="calc-cell" id="aff_w">0</td>
          <td class="fixed-cell">104.5</td>
          <td class="calc-cell" id="aff_m">0</td>
        </tr>

        <tr class="section-row">
          <td colspan="2" class="left-text">Landing Condition (Max 3979)</td>
          <td class="calc-cell" id="lw_w">0</td>
          <td class="calc-cell" id="lw_cg">0</td>
          <td class="calc-cell" id="lw_m">0</td>
        </tr>
      </tbody>
    </table>
  </form>

  <div class="result-summary">
    <div class="result-card">
      <h3>Takeoff Weight</h3>
      <span class="value" id="res_tow">0 lbs</span>
      <span id="res_tow_status" class="status-ok">Within Limits</span>
    </div>
    <div class="result-card">
      <h3>Landing Weight</h3>
      <span class="value" id="res_lw">0 lbs</span>
      <span id="res_lw_status" class="status-ok">Within Limits</span>
    </div>
    <div class="result-card">
      <h3>Takeoff C.G.</h3>
      <span class="value" id="res_cg">0 in</span>
    </div>
  </div>

  <div style="margin-top: 50px;">
    <h2 class="chart-title">Weight and Balance Chart</h2>
    <div class="chart-wrapper">
      <div class="chart-container">
        <canvas id="wbChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('wbChart').getContext('2d');
  
  const envelopePoints = [
    {x: 92.52, y: 3197},
    {x: 92.52, y: 3252},
    {x: 94.61, y: 4189},
    {x: 97.64, y: 4189},
    {x: 97.64, y: 3748},
    {x: 96.46, y: 3197},
    {x: 92.52, y: 3197}
  ];

  const wbChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Envelope',
          data: envelopePoints,
          showLine: true, borderColor: '#000', borderWidth: 2, pointRadius: 0, fill: false, tension: 0, z: 5
        },
        {
          label: 'Max Zero Fuel',
          data: [{x: 92, y: 3900}, {x: 98, y: 3900}],
          showLine: true, borderColor: 'red', borderDash: [5, 5], borderWidth: 1, pointRadius: 0
        },
        {
          label: 'MAX Landing Weight',
          data: [{x: 92, y: 3979}, {x: 98, y: 3979}],
          showLine: true, borderColor: 'green', borderDash: [3, 3], borderWidth: 1, pointRadius: 0
        },
        {
          label: 'Flight States',
          data: [], backgroundColor: 'blue', pointRadius: 7, pointHoverRadius: 9, z: 10
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { 
          min: 92.0, max: 98.0, 
          ticks: {
            stepSize: 0.5,
            callback: function(v) { return [92, 94, 96, 98].includes(v) ? v : ''; },
            font: { weight: 'bold' }
          },
          title: { display: true, text: 'C.G. Inches Aft of Datum', font: { weight: 'bold' } }
        },
        y: { 
          min: 3100, max: 4200, 
          ticks: {
            stepSize: 100,
            callback: function(v) { return [3100, 3300, 3500, 3700, 3900, 4100].includes(v) ? v : ''; },
            font: { weight: 'bold' }
          },
          title: { display: true, text: 'Weight (lbs)', font: { weight: 'bold' } }
        }
      },
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => `${ctx.raw.label}: (${ctx.raw.x.toFixed(2)} in, ${ctx.raw.y.toFixed(1)} lbs)`
          }
        }
      }
    }
  });

  function calculate() {
    const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
    const setTxt = (id, val, dec = 0) => {
      const el = document.getElementById(id);
      if(el) el.innerText = val.toLocaleString(undefined, {minimumFractionDigits: dec, maximumFractionDigits: dec});
    };

    // 1. BEW
    const bw = getVal('bew_weight'), ba = getVal('bew_arm'), bm = bw * ba;
    setTxt('bew_mom', bm);

    // 2. Passengers & Cargo
    const pW = getVal('p_w') + getVal('fp_w'), pM = pW * 90.6;
    setTxt('p_m', getVal('p_w') * 90.6); setTxt('fp_m', getVal('fp_w') * 90.6);

    const rW = getVal('r1_w') + getVal('r2_w'), rM = rW * 128.0;
    setTxt('r1_m', getVal('r1_w') * 128.0); setTxt('r2_m', getVal('r2_w') * 128.0);

    const cnW = getVal('cn_w'), cnM = cnW * 23.6; setTxt('cn_m', cnM);
    const ccW = getVal('cc_w'), ccM = ccW * 153.1; setTxt('cc_m', ccM);
    const ceW = getVal('ce_w'), ceM = ceW * 178.7; setTxt('ce_m', ceM);

    // 3. De-ice
    const diW = getVal('di_g') * 9.2, diM = diW * 39.4;
    setTxt('di_w', diW, 1); setTxt('di_m', diM);

    // 4. Zero Fuel Condition
    const zfwW = bw + pW + rW + cnW + ccW + ceW + diW;
    const zfwM = bm + pM + rM + cnM + ccM + ceM + diM;
    const zfwCG = zfwW > 0 ? zfwM / zfwW : 0;
    setTxt('zfw_w', zfwW, 1); setTxt('zfw_m', zfwM); setTxt('zfw_cg', zfwCG, 2);

    // 5. Fuel & Takeoff
    const mfW = getVal('mf_g') * 7.01, mfM = mfW * 103.5;
    const afW = getVal('af_g') * 7.01, afM = afW * 126.0;
    setTxt('mf_w', mfW, 1); setTxt('mf_m', mfM);
    setTxt('af_w', afW, 1); setTxt('af_m', afM);

    const towW = zfwW + mfW + afW - 7.01; // -1 gal for taxi
    const towM = zfwM + mfM + afM - 726;
    const towCG = towW > 0 ? towM / towW : 0;
    setTxt('tow_w', towW, 1); setTxt('tow_m', towM); setTxt('tow_cg', towCG, 2);

    // 6. Flight Burn & Landing (Correction Here)
    const mffVal = getVal('mff_g');
    const affVal = getVal('aff_g');
    
    // 重量計算（消費するのでマイナス）
    const mffWeight = -(mffVal * 7.01);
    const affWeight = -(affVal * 7.01);
    
    // モーメント計算（重量 × Arm）※ここが修正箇所
    const mffMoment = mffWeight * 103.5;
    const affMoment = affWeight * 104.5;

    // 表示更新
    setTxt('mff_w', mffWeight, 1); setTxt('mff_m', mffMoment);
    setTxt('aff_w', affWeight, 1); setTxt('aff_m', affMoment);

    // Landing Weight計算
    const lwW = towW + mffWeight + affWeight; // すでにマイナス値なので足す
    const lwM = towM + mffMoment + affMoment; // すでにマイナス値なので足す
    const lwCG = lwW > 0 ? lwM / lwW : 0;
    setTxt('lw_w', lwW, 1); setTxt('lw_m', lwM); setTxt('lw_cg', lwCG, 2);

    // Result Summary
    document.getElementById('res_tow').innerText = towW.toFixed(1) + " lbs";
    document.getElementById('res_lw').innerText = lwW.toFixed(1) + " lbs";
    document.getElementById('res_cg').innerText = towCG.toFixed(2) + " in";

    const towS = document.getElementById('res_tow_status');
    towS.innerText = towW > 4189 ? "OVERWEIGHT!" : "Within Limits";
    towS.className = towW > 4189 ? "status-alert" : "status-ok";

    const lwS = document.getElementById('res_lw_status');
    lwS.innerText = lwW > 3979 ? "OVERWEIGHT!" : "Within Limits";
    lwS.className = lwW > 3979 ? "status-alert" : "status-ok";

    // Chart Update
    // 数値が正常（NaNでない、かつ妥当な範囲）な場合のみプロットする安全策
    const points = [];
    if(zfwW > 0) points.push({x: zfwCG, y: zfwW, label: 'ZFW'});
    if(towW > 0) points.push({x: towCG, y: towW, label: 'TOW'});
    if(lwW > 0)  points.push({x: lwCG, y: lwW, label: 'LDG'});

    wbChart.data.datasets[3].data = points;
    wbChart.update();
  }

  document.querySelectorAll('input').forEach(i => i.addEventListener('input', calculate));
  calculate(); // 初期実行
});
</script>

</body>
</html>
