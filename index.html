<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>DA42NG Weight & Balance Calculator (Precision Chart)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
  :root {
    --primary-color: #0078D4;
    --bg-color: #f4f7f9;
    --card-bg: #ffffff;
    --text-main: #1a1a1a;
    --input-bg: #fff9c4;
    --border-color: #ddd;
    --alert-color: #d32f2f;
    --safe-color: #388e3c;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: var(--bg-color);
    margin: 0;
    padding: 20px;
    color: var(--text-main);
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--card-bg);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  header {
    margin-bottom: 25px;
    border-bottom: 3px solid var(--primary-color);
    padding-bottom: 10px;
  }

  header h1 { margin: 0; color: var(--primary-color); font-size: 22px; }

  .wb-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    font-size: 14px;
  }
  .wb-table th, .wb-table td {
    border: 1px solid var(--border-color);
    padding: 10px 12px;
    text-align: right;
  }
  .wb-table th { background: #f0f0f0; font-weight: bold; text-align: center; }
  .wb-table th.left-align { text-align: left; }
  .input-cell { background-color: var(--input-bg); width: 100px; padding: 0; }
  
  .input-cell input::-webkit-outer-spin-button,
  .input-cell input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  .input-cell input[type=number] {
    -moz-appearance: textfield;
    width: 100%; height: 100%; border: none; background: transparent;
    text-align: right; font-size: 15px; font-weight: bold; padding: 10px 12px;
    box-sizing: border-box; outline: none;
  }

  .calc-cell { background-color: #ffffff; font-weight: bold; }
  .fixed-cell { background-color: #fafafa; color: #666; }
  .section-row td { background-color: #f5f5f5; font-weight: bold; border-top: 2px solid #aaa; }
  .left-text { text-align: left !important; }

  .result-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 30px;
  }
  .result-card {
    background: #fff; border: 1px solid #ddd; padding: 20px;
    border-radius: 8px; text-align: center;
  }
  .result-card .value { font-size: 28px; font-weight: bold; display: block; }
  .status-ok { color: var(--safe-color); font-weight: bold; }
  .status-alert { color: var(--alert-color); font-weight: bold; }

  .chart-section {
    margin-top: 50px;
  }
  h2.chart-title {
    font-size: 20px;
    text-align: center;
    margin-bottom: 5px;
    font-weight: bold;
    text-decoration: underline;
  }
  
  .chart-wrapper {
    position: relative;
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    border: 3px solid #000;
    background: white;
    padding: 0;
  }
   
  .chart-container {
    position: relative;
    width: 100%;
    padding-bottom: 68%; 
    height: 0;
  }

  #wbChart {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .chart-legend-overlay {
    position: absolute;
    top: 15px;
    left: 60px;
    background: rgba(255, 255, 255, 0.9);
    padding: 5px;
    pointer-events: none;
    font-family: Arial, sans-serif;
    font-size: 12px;
    z-index: 10;
  }
  .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 4px;
  }
  .legend-line {
    width: 30px;
    height: 0;
    margin-right: 8px;
    border-top-width: 3px;
  }
  .l-env { border-top-style: solid; border-top-color: #444; border-top-width: 5px; }
  .l-zfw { border-top-style: dashed; border-top-color: red; border-top-width: 2px; }
  .l-ldg { border-top-style: dotted; border-top-color: #0078D4; border-top-width: 3px; }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>DA42NG Weight & Balance Calculator</h1>
    <p>Test run</p>
  </header>

  <form id="wbForm">
    <table class="wb-table">
      <thead>
        <tr>
          <th class="left-align">Position</th>
          <th style="width: 60px;">Qty</th>
          <th style="width: 90px;">Weight (lbs)</th>
          <th style="width: 70px;">Arm (in)</th>
          <th>Moment (in-lbs)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="left-text">Basic Empty Weight</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="bew_weight" value="3150.4" step="0.1"></td>
          <td class="input-cell"><input type="number" id="bew_arm" value="94.7" step="0.1"></td>
          <td class="calc-cell" id="bew_mom">0</td>
        </tr>
        <tr>
          <td class="left-text">Pilot</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="p_w" placeholder="0"></td>
          <td class="fixed-cell">90.6</td>
          <td class="calc-cell" id="p_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Front Passenger</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="fp_w" placeholder="0"></td>
          <td class="fixed-cell">90.6</td>
          <td class="calc-cell" id="fp_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Rear Passenger 1</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="r1_w" placeholder="0"></td>
          <td class="fixed-cell">128.0</td>
          <td class="calc-cell" id="r1_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Rear Passenger 2</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="r2_w" placeholder="0"></td>
          <td class="fixed-cell">128.0</td>
          <td class="calc-cell" id="r2_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Nose (Max 66)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="cn_w" placeholder="0"></td>
          <td class="fixed-cell">23.6</td>
          <td class="calc-cell" id="cn_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Cabin (Max 100)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="cc_w" placeholder="0"></td>
          <td class="fixed-cell">153.1</td>
          <td class="calc-cell" id="cc_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Extend (Max 40)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="ce_w" placeholder="0"></td>
          <td class="fixed-cell">178.7</td>
          <td class="calc-cell" id="ce_m">0</td>
        </tr>
        <tr>
          <td class="left-text">De-ice Fluid (9.2 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="di_g" placeholder="0"></td>
          <td class="calc-cell" id="di_w">0</td>
          <td class="fixed-cell">39.4</td>
          <td class="calc-cell" id="di_m">0</td>
        </tr>
        <tr class="section-row">
          <td colspan="2" class="left-text">Zero Fuel Condition</td>
          <td class="calc-cell" id="zfw_w">0</td>
          <td class="calc-cell" id="zfw_cg">0</td>
          <td class="calc-cell" id="zfw_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Main Fuel Load (7.01 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="mf_g" placeholder="0"></td>
          <td class="calc-cell" id="mf_w">0</td>
          <td class="fixed-cell">103.5</td>
          <td class="calc-cell" id="mf_m">0</td>
        </tr>
        <tr>
          <td class="left-text">AUX Fuel Load (7.01 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="af_g" placeholder="0"></td>
          <td class="calc-cell" id="af_w">0</td>
          <td class="fixed-cell">126.0</td>
          <td class="calc-cell" id="af_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Runup/Taxi Burn off</td>
          <td class="fixed-cell">-1.0</td>
          <td class="fixed-cell">-7.01</td>
          <td class="fixed-cell">103.5</td>
          <td class="fixed-cell">-726</td>
        </tr>
        <tr class="section-row">
          <td colspan="2" class="left-text">Takeoff Condition (Max 4189)</td>
          <td class="calc-cell" id="tow_w">0</td>
          <td class="calc-cell" id="tow_cg">0</td>
          <td class="calc-cell" id="tow_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Main Fuel for Flight</td>
          <td class="input-cell"><input type="number" id="mff_g" placeholder="0"></td>
          <td class="calc-cell" id="mff_w">0</td>
          <td class="fixed-cell">103.5</td>
          <td class="calc-cell" id="mff_m">0</td>
        </tr>
        <tr>
          <td class="left-text">AUX Fuel for Flight</td>
          <td class="input-cell"><input type="number" id="aff_g" placeholder="0"></td>
          <td class="calc-cell" id="aff_w">0</td>
          <td class="fixed-cell">104.5</td>
          <td class="calc-cell" id="aff_m">0</td>
        </tr>
        <tr class="section-row">
          <td colspan="2" class="left-text">Landing Condition (Max 3979)</td>
          <td class="calc-cell" id="lw_w">0</td>
          <td class="calc-cell" id="lw_cg">0</td>
          <td class="calc-cell" id="lw_m">0</td>
        </tr>
      </tbody>
    </table>
  </form>

  <div class="result-summary">
    <div class="result-card">
      <h3>Takeoff Weight</h3>
      <span class="value" id="res_tow">0 lbs</span>
      <span id="res_tow_status" class="status-ok">Within Limits</span>
    </div>
    <div class="result-card">
      <h3>Landing Weight</h3>
      <span class="value" id="res_lw">0 lbs</span>
      <span id="res_lw_status" class="status-ok">Within Limits</span>
    </div>
    <div class="result-card">
      <h3>Takeoff C.G.</h3>
      <span class="value" id="res_cg">0 in</span>
    </div>
  </div>

  <div class="chart-section">
    <h2 class="chart-title">Weight and Balance Chart</h2>
    <div class="chart-wrapper">
      <div class="chart-legend-overlay">
        <div class="legend-item"><div class="legend-line l-env"></div>Envelope</div>
        <div class="legend-item"><div class="legend-line l-zfw"></div>Max Zero Fuel</div>
        <div class="legend-item"><div class="legend-line l-ldg"></div>MAX Landing Weight</div>
      </div>
      <div class="chart-container">
        <canvas id="wbChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  Chart.defaults.color = '#000';
  Chart.defaults.font.family = 'Arial';
  Chart.defaults.font.weight = 'bold';

  const ctx = document.getElementById('wbChart').getContext('2d');
  
  // ★正確なデータに基づきエンベロープ座標を修正★
  const envelopePoints = [
    {x: 92.52, y: 3197}, // 前方限界 始点
    {x: 92.52, y: 3236}, // 前方限界 折れ点 (1468kg)
    {x: 95.20, y: 4189}, // 前方限界 MTOM
    {x: 97.64, y: 4189}, // 後方限界 MTOM (水平線)
    {x: 97.64, y: 3748}, // 後方限界 折れ点 (1700kg)
    {x: 96.61, y: 3197}, // 後方限界 終点 (1450kg)
    {x: 92.52, y: 3197}  // 閉じる
  ];

  const wbChart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Envelope',
          data: envelopePoints,
          showLine: true,
          borderColor: '#444444', 
          borderWidth: 5,
          pointRadius: 0,
          fill: false,
          tension: 0,
          order: 1
        },
        {
          label: 'Max Zero Fuel',
          data: [{x: 92, y: 3900}, {x: 98, y: 3900}],
          showLine: true,
          borderColor: 'red',
          borderDash: [10, 5],
          borderWidth: 2,
          pointRadius: 0,
          order: 2
        },
        {
          label: 'MAX Landing Weight',
          data: [{x: 92, y: 3979}, {x: 98, y: 3979}],
          showLine: true,
          borderColor: '#0078D4',
          borderDash: [2, 3],
          borderWidth: 3,
          pointRadius: 0,
          order: 3
        },
        {
          label: 'Flight States',
          data: [],
          backgroundColor: ['orange', 'green', 'blue'],
          borderColor: 'black',
          borderWidth: 1,
          pointRadius: 6,
          pointHoverRadius: 8,
          order: 0
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          enabled: true,
          callbacks: {
            label: (ctx) => `${ctx.raw.label || ''}: ${ctx.raw.x.toFixed(2)} in, ${ctx.raw.y.toFixed(0)} lbs`
          }
        }
      },
      scales: {
        x: { 
          min: 92.0, max: 98.0, 
          grid: { color: '#000000', lineWidth: 1 },
          ticks: {
            stepSize: 0.5,
            color: '#000',
            font: { size: 14, weight: 'bold' },
            callback: value => (value % 2 === 0) ? value : ''
          },
          title: { display: true, text: 'C.G. - Inches Aft of Datum', font: { size: 16, weight: 'bold' } }
        },
        y: { 
          min: 3100, max: 4200, 
          grid: { color: '#000000', lineWidth: 1 },
          ticks: {
            stepSize: 100,
            color: '#000',
            font: { size: 14, weight: 'bold' },
            callback: value => ((value - 3100) % 200 === 0) ? value : ''
          },
          title: { display: true, text: 'Weight (lbs)', font: { size: 16, weight: 'bold' } }
        }
      }
    }
  });

  function calculate() {
    const getVal = (id) => parseFloat(document.getElementById(id).value) || 0;
    const setTxt = (id, val, dec = 0) => {
      const el = document.getElementById(id);
      if(el) el.innerText = val.toLocaleString(undefined, {minimumFractionDigits: dec, maximumFractionDigits: dec});
    };

    const bw = getVal('bew_weight'), ba = getVal('bew_arm'), bm = bw * ba;
    setTxt('bew_mom', bm);

    const pW = getVal('p_w') + getVal('fp_w'), pM = pW * 90.6;
    setTxt('p_m', getVal('p_w') * 90.6); setTxt('fp_m', getVal('fp_w') * 90.6);

    const rW = getVal('r1_w') + getVal('r2_w'), rM = rW * 128.0;
    setTxt('r1_m', getVal('r1_w') * 128.0); setTxt('r2_m', getVal('r2_w') * 128.0);

    const cnW = getVal('cn_w'), cnM = cnW * 23.6; setTxt('cn_m', cnM);
    const ccW = getVal('cc_w'), ccM = ccW * 153.1; setTxt('cc_m', ccM);
    const ceW = getVal('ce_w'), ceM = ceW * 178.7; setTxt('ce_m', ceM);

    const diW = getVal('di_g') * 9.2, diM = diW * 39.4;
    setTxt('di_w', diW, 1); setTxt('di_m', diM);

    const zfwW = bw + pW + rW + cnW + ccW + ceW + diW;
    const zfwM = bm + pM + rM + cnM + ccM + ceM + diM;
    const zfwCG = zfwW > 0 ? zfwM / zfwW : 0;
    setTxt('zfw_w', zfwW, 1); setTxt('zfw_m', zfwM); setTxt('zfw_cg', zfwCG, 2);

    const mfW = getVal('mf_g') * 7.01, mfM = mfW * 103.5;
    const afW = getVal('af_g') * 7.01, afM = afW * 126.0;
    setTxt('mf_w', mfW, 1); setTxt('mf_m', mfM);
    setTxt('af_w', afW, 1); setTxt('af_m', afM);

    const towW = zfwW + mfW + afW - 7.01;
    const towM = zfwM + mfM + afM - 726;
    const towCG = towW > 0 ? towM / towW : 0;
    setTxt('tow_w', towW, 1); setTxt('tow_m', towM); setTxt('tow_cg', towCG, 2);

    const mffVal = getVal('mff_g'), affVal = getVal('aff_g');
    const mffWeight = -(mffVal * 7.01), affWeight = -(affVal * 7.01);
    const mffMoment = mffWeight * 103.5, affMoment = affWeight * 104.5;

    setTxt('mff_w', mffWeight, 1); setTxt('mff_m', mffMoment);
    setTxt('aff_w', affWeight, 1); setTxt('aff_m', affMoment);

    const lwW = towW + mffWeight + affWeight;
    const lwM = towM + mffMoment + affMoment;
    const lwCG = lwW > 0 ? lwM / lwW : 0;
    setTxt('lw_w', lwW, 1); setTxt('lw_m', lwM); setTxt('lw_cg', lwCG, 2);

    document.getElementById('res_tow').innerText = towW.toFixed(1) + " lbs";
    document.getElementById('res_lw').innerText = lwW.toFixed(1) + " lbs";
    document.getElementById('res_cg').innerText = towCG.toFixed(2) + " in";

    const towS = document.getElementById('res_tow_status');
    towS.innerText = towW > 4189 ? "OVERWEIGHT!" : "Within Limits";
    towS.className = towW > 4189 ? "status-alert" : "status-ok";

    const lwS = document.getElementById('res_lw_status');
    lwS.innerText = lwW > 3979 ? "OVERWEIGHT!" : "Within Limits";
    lwS.className = lwW > 3979 ? "status-alert" : "status-ok";

    const points = [];
    if(zfwW > 0) points.push({x: zfwCG, y: zfwW, label: 'ZFW'});
    if(towW > 0) points.push({x: towCG, y: towW, label: 'TOW'});
    if(lwW > 0)  points.push({x: lwCG, y: lwW, label: 'LDG'});

    wbChart.data.datasets[3].data = points;
    wbChart.update();
  }

  document.querySelectorAll('input').forEach(i => i.addEventListener('input', calculate));
  calculate();
});
</script>

</body>
</html>
