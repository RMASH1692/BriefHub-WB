<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>DA42NG Weight & Balance Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<style>
  :root {
    --primary-color: #0078D4;
    --bg-color: #f4f7f9;
    --card-bg: #ffffff;
    --text-main: #1a1a1a;
    --text-sub: #666666;
    --input-bg: #fff9c4;
    --calc-bg: #ffffff;
    --border-color: #ddd;
    --alert-color: #d32f2f;
    --safe-color: #388e3c;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
    background: var(--bg-color);
    margin: 0;
    padding: 20px;
    color: var(--text-main);
  }

  .container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--card-bg);
    padding: 30px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
  }

  header {
    margin-bottom: 25px;
    border-bottom: 3px solid var(--primary-color);
    padding-bottom: 10px;
  }

  header h1 { margin: 0; color: var(--primary-color); font-size: 22px; }
  header p { margin: 5px 0 0; font-size: 13px; color: var(--text-sub); }

  .wb-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
    font-size: 14px;
  }

  .wb-table th, .wb-table td {
    border: 1px solid var(--border-color);
    padding: 10px 12px;
    text-align: right;
  }

  .wb-table th { background: #f0f0f0; font-weight: bold; text-align: center; }
  .wb-table th.left-align { text-align: left; }

  .input-cell { background-color: var(--input-bg); width: 100px; padding: 0; }
  .input-cell input {
    width: 100%; height: 100%; border: none; background: transparent;
    text-align: right; font-size: 15px; font-weight: bold; padding: 10px 12px;
    box-sizing: border-box; outline: none;
  }

  input::-webkit-outer-spin-button, input::-webkit-inner-spin-button {
    -webkit-appearance: none; margin: 0;
  }
  input[type=number] { -moz-appearance: textfield; }

  .calc-cell { background-color: var(--calc-bg); font-weight: bold; }
  .fixed-cell { background-color: #fafafa; color: #666; }
  .section-row td { background-color: #f5f5f5; font-weight: bold; border-top: 2px solid #aaa; }
  .left-text { text-align: left !important; }

  .result-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 30px;
  }

  .result-card {
    background: #fff; border: 1px solid #ddd; padding: 20px;
    border-radius: 8px; text-align: center;
  }

  .result-card .value { font-size: 28px; font-weight: bold; display: block; }
  .status-ok { color: var(--safe-color); font-weight: bold; }
  .status-alert { color: var(--alert-color); font-weight: bold; }

  .chart-container {
    margin-top: 40px; padding: 20px; background: #fff;
    border: 1px solid #ddd; border-radius: 12px; height: 550px;
  }

  @media (max-width: 600px) {
    .container { padding: 15px; }
    .chart-container { height: 350px; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>DA42NG Weight & Balance</h1>
    <p>JA224T Load Sheet Calculation</p>
  </header>

  <form id="wbForm">
    <table class="wb-table">
      <thead>
        <tr>
          <th class="left-align">Position</th>
          <th style="width: 60px;">Qty<br>(gal)</th>
          <th style="width: 90px;">Weight<br>(lbs)</th>
          <th style="width: 70px;">Arm<br>(in)</th>
          <th>Moment<br>(in-lbs)</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="left-text">Basic Empty Weight</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="bew_weight" value="3150.4" step="0.1"></td>
          <td class="input-cell"><input type="number" id="bew_arm" value="94.7" step="0.01"></td>
          <td class="calc-cell" id="bew_mom">0</td>
        </tr>
        <tr>
          <td class="left-text">Pilot</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="p_w" value=""></td>
          <td class="fixed-cell">90.6</td>
          <td class="calc-cell" id="p_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Front Passenger</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="fp_w" value=""></td>
          <td class="fixed-cell">90.6</td>
          <td class="calc-cell" id="fp_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Rear Passenger 1</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="r1_w" value=""></td>
          <td class="fixed-cell">128.0</td>
          <td class="calc-cell" id="r1_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Rear Passenger 2</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="r2_w" value=""></td>
          <td class="fixed-cell">128.0</td>
          <td class="calc-cell" id="r2_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Nose (Max 66)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="cn_w" value="5"></td>
          <td class="fixed-cell">23.6</td>
          <td class="calc-cell" id="cn_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Cabin (Max 100)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="cc_w" value="20"></td>
          <td class="fixed-cell">153.1</td>
          <td class="calc-cell" id="cc_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Cargo Extend (Max 40)</td>
          <td>-</td>
          <td class="input-cell"><input type="number" id="ce_w" value="2"></td>
          <td class="fixed-cell">178.7</td>
          <td class="calc-cell" id="ce_m">0</td>
        </tr>
        <tr>
          <td class="left-text">De-ice Fluid (9.2 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="di_g" value=""></td>
          <td class="calc-cell" id="di_w">0</td>
          <td class="fixed-cell">39.4</td>
          <td class="calc-cell" id="di_m">0</td>
        </tr>

        <tr class="section-row">
          <td colspan="2" class="left-text">Zero Fuel Condition (Max 3900)</td>
          <td class="calc-cell" id="zfw_w">0</td>
          <td class="calc-cell" id="zfw_cg">0</td>
          <td class="calc-cell" id="zfw_m">0</td>
        </tr>

        <tr>
          <td class="left-text">Main Fuel Load (7.01 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="mf_g" value=""></td>
          <td class="calc-cell" id="mf_w">0</td>
          <td class="fixed-cell">103.5</td>
          <td class="calc-cell" id="mf_m">0</td>
        </tr>
        <tr>
          <td class="left-text">AUX Fuel Load (7.01 lbs/gal)</td>
          <td class="input-cell"><input type="number" id="af_g" value="0"></td>
          <td class="calc-cell" id="af_w">0</td>
          <td class="fixed-cell">126.0</td>
          <td class="calc-cell" id="af_m">0</td>
        </tr>
        <tr>
          <td class="left-text">Runup/Taxi Burn off</td>
          <td class="fixed-cell">-1.0</td>
          <td class="fixed-cell">-7.01</td>
          <td class="fixed-cell">103.5</td>
          <td class="fixed-cell">-726</td>
        </tr>

        <tr class="section-row">
          <td colspan="2" class="left-text">Takeoff Condition (Max 4189)</td>
          <td class="calc-cell" id="tow_w">0</td>
          <td class="calc-cell" id="tow_cg">0</td>
          <td class="calc-cell" id="tow_m">0</td>
        </tr>

        <tr>
          <td class="left-text">Main Fuel for Flight</td>
          <td class="input-cell"><input type="number" id="mff_g" value=""></td>
          <td class="calc-cell" id="mff_w">0</td>
          <td class="fixed-cell">103.5</td>
          <td class="calc-cell" id="mff_m">0</td>
        </tr>
        <tr>
          <td class="left-text">AUX Fuel for Flight</td>
          <td class="input-cell"><input type="number" id="aff_g" value="0"></td>
          <td class="calc-cell" id="aff_w">0</td>
          <td class="fixed-cell">104.5</td>
          <td class="calc-cell" id="aff_m">0</td>
        </tr>

        <tr class="section-row">
          <td colspan="2" class="left-text">Landing Condition (Max 3979)</td>
          <td class="calc-cell" id="lw_w">0</td>
          <td class="calc-cell" id="lw_cg">0</td>
          <td class="calc-cell" id="lw_m">0</td>
        </tr>
      </tbody>
    </table>
  </form>

  <div class="result-summary">
    <div class="result-card">
      <h3>Takeoff Weight</h3>
      <span class="value" id="res_tow">0 lbs</span>
      <span id="res_tow_status" class="status-ok">Within Limits</span>
    </div>
    <div class="result-card">
      <h3>Landing Weight</h3>
      <span class="value" id="res_lw">0 lbs</span>
      <span id="res_lw_status" class="status-ok">Within Limits</span>
    </div>
    <div class="result-card">
      <h3>Takeoff C.G.</h3>
      <span class="value" id="res_cg">0 in</span>
    </div>
  </div>

  <div class="chart-container">
    <canvas id="wbChart"></canvas>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const ctx = document.getElementById('wbChart').getContext('2d');
  
  // エンベロープ座標 (DA42NG AFM図面に基づき正確に再現)
  // Forward Limit: 92.13in at 3100lb, 94.61in at 4189lb
  // Rear Limit: 96.46in at 3100lb, 97.64in at 3748lb, vertical to 97.64in at 4189lb
  const envelopeData = [
    {x: 92.13, y: 3100}, 
    {x: 94.61, y: 4189}, 
    {x: 97.64, y: 4189}, 
    {x: 97.64, y: 3748}, // 屈曲点
    {x: 96.46, y: 3100}, 
    {x: 92.13, y: 3100}
  ];

  const chart = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: [
        {
          label: 'Flight Envelope',
          data: envelopeData,
          showLine: true, borderColor: 'black', borderWidth: 2, pointRadius: 0, fill: false, tension: 0, z: 1
        },
        {
          label: 'Max Zero Fuel (3900 lbs)',
          data: [{x: 91, y: 3900}, {x: 99, y: 3900}],
          showLine: true, borderColor: 'rgba(255, 0, 0, 0.5)', borderDash: [5, 5], borderWidth: 1.5, pointRadius: 0
        },
        {
          label: 'Max Landing (3979 lbs)',
          data: [{x: 91, y: 3979}, {x: 99, y: 3979}],
          showLine: true, borderColor: 'rgba(0, 0, 0, 0.3)', borderDash: [2, 2], borderWidth: 1.5, pointRadius: 0
        },
        {
          label: 'States (ZFW, TOW, LDG)',
          data: [], backgroundColor: 'blue', pointRadius: 7, pointHoverRadius: 9, z: 10
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: {
        x: { type: 'linear', position: 'bottom', min: 91, max: 99, title: { display: true, text: 'C.G. Arm (in)' } },
        y: { min: 3000, max: 4300, title: { display: true, text: 'Weight (lbs)' } }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: (item) => item.raw.label + ': (' + item.raw.x.toFixed(2) + ' in, ' + item.raw.y.toFixed(1) + ' lbs)'
          }
        }
      }
    }
  });

  function getV(id) { 
    const val = parseFloat(document.getElementById(id).value);
    return isNaN(val) ? 0 : val;
  }
  function setT(id, val, dec = 0) { 
    const el = document.getElementById(id);
    if(el) el.innerText = val.toLocaleString(undefined, {minimumFractionDigits: dec, maximumFractionDigits: dec});
  }

  function calculate() {
    // Basic Empty Weight
    const bw = getV('bew_weight'), ba = getV('bew_arm');
    const bm = bw * ba;
    setT('bew_mom', bm, 0);

    // Payload
    const items = [
      {w: getV('p_w'), a: 90.6, id: 'p_m'},
      {w: getV('fp_w'), a: 90.6, id: 'fp_m'},
      {w: getV('r1_w'), a: 128.0, id: 'r1_m'},
      {w: getV('r2_w'), a: 128.0, id: 'r2_m'},
      {w: getV('cn_w'), a: 23.6, id: 'cn_m'},
      {w: getV('cc_w'), a: 153.1, id: 'cc_m'},
      {w: getV('ce_w'), a: 178.7, id: 'ce_m'}
    ];
    let payloadW = 0, payloadM = 0;
    items.forEach(i => {
      const m = i.w * i.a;
      setT(i.id, m, 0);
      payloadW += i.w;
      payloadM += m;
    });

    // De-ice (9.2 lbs/gal)
    const diW = getV('di_g') * 9.2;
    const diM = diW * 39.4;
    setT('di_w', diW, 1); setT('di_m', diM, 0);

    // Zero Fuel Weight (ZFW)
    const zfwW = bw + payloadW + diW;
    const zfwM = bm + payloadM + diM;
    const zfwCG = zfwW > 0 ? zfwM / zfwW : 0;
    setT('zfw_w', zfwW, 1); setT('zfw_m', zfwM, 0); setT('zfw_cg', zfwCG, 2);

    // Fuel (7.01 lbs/gal)
    const mfW = getV('mf_g') * 7.01, mfM = mfW * 103.5;
    setT('mf_w', mfW, 1); setT('mf_m', mfM, 0);
    const afW = getV('af_g') * 7.01, afM = afW * 126.0;
    setT('af_w', afW, 1); setT('af_m', afM, 0);

    // Takeoff Weight (TOW) - includes taxi burn
    const towW = zfwW + mfW + afW - 7.01;
    const towM = zfwM + mfM + afM - 726;
    const towCG = towW > 0 ? towM / towW : 0;
    setT('tow_w', towW, 1); setT('tow_m', towM, 0); setT('tow_cg', towCG, 2);

    // Flight Burn
    const mffW = getV('mff_g') * 7.01, mffM = mffW * 103.5;
    setT('mff_w', -mffW, 1); setT('mff_m', -mffM, 0);
    const affW = getV('aff_g') * 7.01, affM = affW * 104.5;
    setT('aff_w', -affW, 1); setT('aff_m', -affM, 0);

    // Landing Weight (LW)
    const lwW = towW - mffW - affW;
    const lwM = towM - mffM - affM;
    const lwCG = lwW > 0 ? lwM / lwW : 0;
    setH('lw_w', lwW, 1); setH('lw_m', lwM, 0); setH('lw_cg', lwCG, 2);

    function setH(id, val, dec) {
      document.getElementById(id).innerText = val.toFixed(dec);
    }

    // Results UI
    document.getElementById('res_tow').innerText = towW.toFixed(1) + " lbs";
    document.getElementById('res_lw').innerText = lwW.toFixed(1) + " lbs";
    document.getElementById('res_cg').innerText = towCG.toFixed(2) + " in";

    const ts = document.getElementById('res_tow_status');
    if(towW > 4189) { ts.innerText = "OVERWEIGHT!"; ts.className = "status-alert"; }
    else { ts.innerText = "Within Limits"; ts.className = "status-ok"; }

    const ls = document.getElementById('res_lw_status');
    if(lwW > 3979) { ls.innerText = "OVERWEIGHT!"; ls.className = "status-alert"; }
    else { ls.innerText = "Within Limits"; ls.className = "status-ok"; }

    // Chart Update
    chart.data.datasets[3].data = [
      {x: zfwCG, y: zfwW, label: 'ZFW'},
      {x: towCG, y: towW, label: 'TOW'},
      {x: lwCG, y: lwW, label: 'LDG'}
    ];
    chart.update();
  }

  document.querySelectorAll('input').forEach(i => i.addEventListener('input', calculate));
  calculate();
});
</script>

</body>
</html>
